// Updated GalleryGrid.tsx (fixed ProofingImage â†’ Image import)

// NOTE: If you have a second gallery-grid.tsx (lowercase filename), update it too:
// Replace:
//    import type { ProofingImage } from "@/lib/types";
// With:
//    import type { Image } from "@/lib/types";
// And update props:
//    images: Image[];
// Added mark(id, null) handling and onClear forwarding.

"use client";

import React, { useState, useEffect } from "react";
import { Image } from "@/lib/types";
import { getAlbumImages, sendSelection } from "@/lib/api";
import ImageCard from "./ImageCard";
import Lightbox from "./Lightbox";

interface Props {
  albumId: number;
  sessionToken: string;
  sessionEmail?: string | null;
}

export default function GalleryGrid({ albumId, sessionToken, sessionEmail }: Props) {
  const [images, setImages] = useState<Image[]>([]);
  const [loading, setLoading] = useState(true);
  const [currentIndex, setCurrentIndex] = useState<number | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function load() {
      try {
        setError(null);
        const imgs = await getAlbumImages(albumId, sessionToken);
        setImages(imgs);
      } catch (err: any) {
        setError(err?.message ?? "Unable to load images");
      } finally {
        setLoading(false);
      }
    }
    load();
  }, [albumId, sessionToken]);

  useEffect(() => {
    if (sessionEmail) {
      localStorage.setItem("clientproofing:email", sessionEmail);
    }
  }, [sessionEmail]);

  const mark = async (id: number, state: "favorite" | "approved" | "rejected" | null) => {
    // Optimistic UI update
    setImages((prev) => prev.map((img) => (img.id === id ? { ...img, state } : img)));

    await sendSelection({ sessionToken, imageId: id, state });
  };

  const open = (index: number) => setCurrentIndex(index);
  const close = () => setCurrentIndex(null);
  const prev = () => setCurrentIndex((i) => (i! > 0 ? i! - 1 : images.length - 1));
  const next = () => setCurrentIndex((i) => (i! < images.length - 1 ? i! + 1 : 0));

  if (loading) return <div className="text-neutral-400 w-full text-center py-10">Loading...</div>;
  if (error) return <div className="text-red-400 w-full text-center py-10">{error}</div>;

  return (
    <>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-2">
        {images.map((img, index) => (
          <ImageCard
            key={img.id}
            image={img}
            onClick={() => open(index)}
            onFavorite={() => mark(img.id, "favorite")}
            onApprove={() => mark(img.id, "approved")}
            onReject={() => mark(img.id, "rejected")}
            onClear={() => mark(img.id, null)}
          />
        ))}
      </div>

      {currentIndex !== null && (
        <Lightbox
          image={images[currentIndex]}
			onClose={close}
			onPrev={prev}
			onNext={next}
			onFavorite={(id) => mark(id, "favorite")}
			onApprove={(id) => mark(id, "approved")}
			onReject={(id) => mark(id, "rejected")}
			onClear={(id) => mark(id, null)}
        />
      )}
    </>
  );
}